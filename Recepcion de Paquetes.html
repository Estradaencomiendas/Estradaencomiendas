<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Configuración del encabezado -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepción de Paquetes</title>
    <link href="https://fonts.googleapis.com/css2?family=Acumin+Variable+Concept&display=swap" rel="stylesheet">
    <!-- Scripts de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA42b2B9K4J8BMWa9FfHXFu2sAR0aFYm-M",
            authDomain: "estradaencomiendas0.firebaseapp.com",
            projectId: "estradaencomiendas0",
            storageBucket: "estradaencomiendas0.appspot.com",
            messagingSenderId: "247979951336",
            appId: "1:247979951336:web:92b6b4bf615595676755d",
            measurementId: "G-BRMC9FZBC"
        };

        // Inicialización de Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Verificar si el usuario está autenticado
        auth.onAuthStateChanged(function(user) {
            if (!user) {
                window.location.href = 'login.html';
            }
        });
    </script>
    <!-- Estilos -->
    <style>
        /* ... (mantén tus estilos existentes aquí) ... */
    </style>
</head>
<body>
    <div class="container">
        <img src="Logo.png" alt="Logo Estrada Encomiendas" class="logo">
        <h1>Recepción de Paquetes</h1>
        <form id="package-form">
            <!-- Campos del formulario -->
            <!-- ... (mantén tus campos de formulario existentes aquí) ... -->
            <button class="submit-button" type="submit">Ingresar Datos</button>
        </form>
    </div>

    <script>
        document.getElementById('package-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const nombreCliente = document.getElementById('nombreCliente').value;
            const nombrePaquete = document.getElementById('nombrePaquete').value;
            const destino = document.getElementById('destino').value;
            const diaEntrega = document.getElementById('dia-entrega').value;
            const valor = document.getElementById('valor').value;
            const valorEnvio = document.getElementById('valorEnvio').value;
            const telefonoVendedora = '+503' + document.getElementById('telefonoVendedora').value;

            const fechaEnvio = new Date().toISOString().split('T')[0];
            const trackingNumber = 'PKG-' + Date.now();

            const user = firebase.auth().currentUser;

            const packageData = {
                trackingNumber,
                nombreCliente,
                nombrePaquete,
                destino,
                diaEntrega,
                valor,
                valorEnvio,
                fechaEnvio,
                recepcionadoPor: user ? user.uid : 'Desconocido'
            };

            try {
                // Guardar en Firestore
                await db.collection('paquetes').doc(trackingNumber).set(packageData);
                console.log('Paquete guardado en Firestore');

                // Enviar mensaje de texto a través de Netlify Functions
                const response = await fetch('/.netlify/functions/send-sms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: telefonoVendedora,
                        message: `Gracias por enviar con Estrada Encomiendas. Tu número de seguimiento es: ${trackingNumber}. Nombre de la clienta: ${nombreCliente}, Destino: ${destino}, Valor: $${valor}.`
                    })
                });

                if (!response.ok) {
                    throw new Error('Error enviando el SMS');
                }

                const result = await response.json();
                console.log('SMS enviado con éxito:', result);

                alert('Datos ingresados con éxito y mensaje enviado');
                window.location.href = `resultados.html?trackingNumber=${trackingNumber}&fechaEnvio=${fechaEnvio}`;
            } catch (error) {
                console.error('Error al guardar el paquete o enviar el mensaje:', error);
            }
        });
    </script>
</body>
</html>

